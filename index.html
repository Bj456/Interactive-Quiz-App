<!-- âœ… PDF Script with Hindi/English & Dynamic Layout -->
<script>
document.getElementById('download-pdf').addEventListener('click', () => {
    generatePDF(window.questions || [], "Teacher Bhaskar Joshi", window.quizSettings ? window.quizSettings.language : 'English');
});

async function generatePDF(questions, developerName, language) {
    if (!questions || questions.length === 0) return alert("No questions available to generate PDF.");

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();

    const margin = 10;
    const colGap = 10;
    const colWidth = (pageWidth - margin * 2 - colGap) / 2;
    const lineHeight = 6;

    // Load Hindi font if required
    let hindiFontLoaded = false;
    if (language === 'Hindi') {
        try {
            const fontUrl = '/fonts/NotoSansDevanagari-Regular.ttf';
            const fontResponse = await fetch(fontUrl);
            if (!fontResponse.ok) throw new Error('Font not found');
            const fontBlob = await fontResponse.blob();

            const reader = new FileReader();
            const base64Promise = new Promise((resolve, reject) => {
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(fontBlob);
            });
            const base64Font = await base64Promise;

            doc.addFileToVFS('NotoSansDevanagari-Regular.ttf', base64Font);
            doc.addFont('NotoSansDevanagari-Regular.ttf', 'NotoSansDevanagari', 'normal');
            hindiFontLoaded = true;
        } catch (error) {
            console.warn('Hindi font load failed, using default font:', error);
        }
    }

    const fontName = (hindiFontLoaded && language === 'Hindi') ? 'NotoSansDevanagari' : 'helvetica';
    doc.setFont(fontName, 'normal');
    doc.setFontSize(10);

    // Initialize positions
    let xLeft = margin, xRight = margin + colWidth + colGap;
    let yLeft = margin + 25, yRight = margin + 25;
    let pageCount = 1;

    // Header function
    const addHeader = () => {
        doc.setFont(fontName, 'bold');
        doc.setFontSize(14);
        doc.text('AI Generated Quiz', pageWidth / 2, margin, { align: 'center' });
        doc.setFontSize(11);
        doc.setFont(fontName, 'normal');
        doc.text(`Topic: ${window.quizSettings ? window.quizSettings.topic : 'General'} | Language: ${language}`, pageWidth / 2, margin + 8, { align: 'center' });
        yLeft = margin + 25;
        yRight = margin + 25;
    };

    addHeader();

    for (let i = 0; i < questions.length; i++) {
        const q = questions[i];

        // Choose shorter column
        const isLeft = yLeft <= yRight;
        const x = isLeft ? xLeft : xRight;
        let y = isLeft ? yLeft : yRight;

        // Split question text
        const splitQuestion = doc.splitTextToSize(`${i + 1}. ${q.question}`, colWidth - 4);
        doc.setFont(fontName, 'normal');
        doc.setFontSize(10);
        doc.text(splitQuestion, x, y);

        let usedHeight = splitQuestion.length * lineHeight;

        // Options
        q.answers.forEach((opt, idx) => {
            const splitOpt = doc.splitTextToSize(`(${String.fromCharCode(97 + idx)}) ${opt}`, colWidth - 4);
            doc.setFontSize(9);
            doc.text(splitOpt, x + 2, y + usedHeight + idx * lineHeight);
        });

        usedHeight += q.answers.length * lineHeight + 4;

        // Update column y
        if (isLeft) yLeft += usedHeight; else yRight += usedHeight;

        // Check page overflow
        if (yLeft > pageHeight - margin - 15 && yRight > pageHeight - margin - 15) {
            // Footer before new page
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.text(`Developed by ${developerName}`, pageWidth / 2, pageHeight - 12, { align: 'center' });
            doc.text(`Page ${pageCount} | Total Questions: ${questions.length}`, pageWidth / 2, pageHeight - 6, { align: 'center' });

            doc.addPage();
            pageCount++;
            addHeader();
        }
    }

    // Final footer on last page
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8);
    doc.text(`Developed by ${developerName}`, pageWidth / 2, pageHeight - 12, { align: 'center' });
    doc.text(`Page ${pageCount} | Total Questions: ${questions.length}`, pageWidth / 2, pageHeight - 6, { align: 'center' });

    const safeTopic = (window.quizSettings ? window.quizSettings.topic : 'General').replace(/[^a-zA-Z0-9]/g, '_');
    doc.save(`AI_Quiz_${language}_${safeTopic}.pdf`);
}
</script>
