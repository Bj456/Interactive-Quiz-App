<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Quiz Generator</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay hidden">
            <div class="spinner"></div>
            <p>Generating quiz with AI... Please wait.</p>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="error-message hidden">
            <p></p>
            <button onclick="this.parentElement.classList.add('hidden')">Ã—</button>
        </div>

        <!-- Start Screen -->
        <div id="start-screen" class="screen">
            <h1>ðŸ¤– AI Quiz Generator</h1>
            <p>Create custom quizzes on any topic using AI!</p>
            
            <form id="quiz-settings-form">
                <div class="form-group">
                    <label for="topic">Topic:</label>
                    <input type="text" id="topic" placeholder="e.g., Roman Empire, Photosynthesis" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="num-questions">Number of Questions:</label>
                        <select id="num-questions">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="15">15</option>
                            <option value="20">20</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="difficulty">Difficulty:</label>
                        <select id="difficulty">
                            <option value="easy">Easy</option>
                            <option value="medium" selected>Medium</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="language">Language:</label>
                        <select id="language">
                            <option value="English" selected>English</option>
                            <option value="Hindi">Hindi</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="timer-duration">Time per Question (seconds):</label>
                        <select id="timer-duration">
                            <option value="30">30</option>
                            <option value="45" selected>45</option>
                            <option value="60">60</option>
                            <option value="90">90</option>
                            <option value="0">No Timer</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Hints:</label>
                    <div class="radio-group">
                        <label><input type="radio" name="hint-option" value="enable" checked> Enable Hints</label>
                        <label><input type="radio" name="hint-option" value="disable"> Disable Hints</label>
                    </div>
                </div>
                
                <button type="submit" id="start-btn" class="btn primary">Generate Quiz</button>
            </form>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="screen hidden">
            <div class="quiz-header">
                <div class="progress-container">
                    <div id="progress-bar" class="progress-bar"></div>
                </div>
                <div class="quiz-info">
                    <span id="question-counter">Question 1 of 10</span>
                    <span id="score-counter">Score: 0</span>
                    <span id="timer">Time: 45</span>
                </div>
            </div>
            
            <div class="question-container">
                <h2 id="question"></h2>
                <div id="answer-buttons" class="answer-buttons"></div>
                
                <div class="quiz-controls">
                    <button id="hint-btn" class="btn secondary hidden">ðŸ’¡ Hint</button>
                    <button id="next-btn" class="btn primary hidden">Next Question</button>
                    <button id="download-pdf" class="btn secondary">ðŸ“„ Download PDF</button>
                </div>
            </div>
        </div>

        <!-- Score Screen -->
        <div id="score-screen" class="screen hidden">
            <div class="score-container">
                <h1>Quiz Complete!</h1>
                <div class="score-display">
                    <h2 id="final-score">You scored 0 out of 10</h2>
                    <p id="score-feedback">Nice try!</p>
                </div>
                <button id="play-again-btn" class="btn primary">Play Again</button>
            </div>
        </div>
    </div>

    <footer>
        <p>Developed by <strong><a href="https://sites.google.com/view/teacher-bhaskar-joshi/home" target="_blank">Teacher Bhaskar Joshi</a></strong></p>
    </footer>

    <!-- Updated PDF Script (Only This Block Changed â€“ Hindi Font Fix with Base64) -->
    <script>
    document.getElementById('download-pdf').addEventListener('click', () => {
        generatePDF(window.questions || [], "Teacher Bhaskar Joshi", window.quizSettings ? window.quizSettings.language : 'English');
    });

    async function generatePDF(questions, developerName, language) {
        if (!questions || questions.length === 0) return alert("No questions available to generate PDF.");

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();

        const margin = 10;
        const colGap = 10;
        const lineHeight = 6;
        const colWidth = (pageWidth - margin * 2 - colGap) / 2;
        const questionsPerPage = 20;

        // Hindi Font Support (Fixed: Base64 for VFS â€“ No More Error)
        let hindiFontLoaded = false;
        if (language === 'Hindi') {
            try {
                const fontUrl = '/fonts/NotoSansDevanagari-Regular.ttf';
                const fontResponse = await fetch(fontUrl);
                if (!fontResponse.ok) throw new Error('Font not found');
                const fontBlob = await fontResponse.blob();
                
                // Convert to base64 string (Required for jsPDF VFS TTF support)
                const reader = new FileReader();
                const base64Promise = new Promise((resolve, reject) => {
                    reader.onload = () => resolve(reader.result.split(',')[1]); // Base64 data only
                    reader.onerror = reject;
                    reader.readAsDataURL(fontBlob);
                });
                const base64Font = await base64Promise;
                
                // Add font to VFS and document
                doc.addFileToVFS('NotoSansDevanagari-Regular.ttf', base64Font);
                doc.addFont('NotoSansDevanagari-Regular.ttf', 'NotoSansDevanagari', 'normal');
                doc.setFont('NotoSansDevanagari');
                hindiFontLoaded = true;
                doc.setFontSize(10);
            } catch (error) {
                console.warn('Hindi font load failed, using default font:', error);
                doc.setFont('helvetica');
                doc.setFontSize(10);
            }
        } else {
            // English/Other: Default font (unchanged)
            doc.setFont('helvetica');
            doc.setFontSize(10);
        }

        let xLeft = margin;
        let xRight = margin + colWidth + colGap;
        let yStart = margin + 10;
        let pageCount = 1;

        // Title (Same as original)
        doc.setFontSize(16);
        doc.text('AI Generated Quiz', pageWidth / 2, margin, { align: 'center' });
        doc.setFontSize(12);
        doc.text(`Topic: ${window.quizSettings ? window.quizSettings.topic : 'General'} | Language: ${language}`, pageWidth / 2, margin + 10, { align: 'center' });
        yStart += 20;

        // Questions Loop (Same logic, with font switch for Hindi)
        for (let i = 0; i < questions.length; i++) {
            const q = questions[i];
            const posInPage = i % questionsPerPage;
            const isLeft = posInPage < 10;
            const x = isLeft ? xLeft : xRight;
            const rowIndex = posInPage % 10;
            let y = yStart + rowIndex * (lineHeight * (q.answers.length + 1) + 5);

            // Question Text
            if (hindiFontLoaded && language === 'Hindi') {
                doc.setFont('NotoSansDevanagari');
            } else {
                doc.setFont('helvetica');
            }
            doc.setFontSize(10);
            const questionText = `${i + 1}. ${q.question}`;
            const splitQuestion = doc.splitTextToSize(questionText, colWidth - 4);
            doc.text(splitQuestion, x, y);

            // Options
            q.answers.forEach((opt, idx) => {
                if (hindiFontLoaded && language === 'Hindi') {
                    doc.setFont('NotoSansDevanagari');
                } else {
                    doc.setFont('helvetica');
                }
                doc.setFontSize(9);
                const optText = `(${String.fromCharCode(97 + idx)}) ${opt}`;
                const splitText = doc.splitTextToSize(optText, colWidth - 4);
                doc.text(splitText, x + 2, y + lineHeight * (idx + 1));
            });

            // New Page & Footer (Same as original)
            if ((posInPage === questionsPerPage - 1) || (i === questions.length - 1)) {
                doc.setFont('helvetica');
                doc.setFontSize(8);
                doc.text(`Developed by ${developerName}`, pageWidth / 2, pageHeight - 12, { align: 'center' });
                doc.text(`Page ${pageCount} | Total Questions: ${questions.length}`, pageWidth / 2, pageHeight - 6, { align: 'center' });

                if (i !== questions.length - 1) {
                    doc.addPage();
                    pageCount++;
                    yStart = margin + 10;
                }
            }
        }

        // Save (Safe filename for Hindi topics)
        const safeTopic = (window.quizSettings ? window.quizSettings.topic : 'General').replace(/[^a-zA-Z0-9]/g, '_');
        doc.save(`AI_Quiz_${language}_${safeTopic}.pdf`);
    }
    </script>

    <script src="script.js"></script>
</body>
</html>
